<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN KC - CONTROL PANEL</title>
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@300;500;700&family=Rajdhani:wght@500;700;900&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #050505; --gold: #FFD700; --cyan: #00F0FF; --red: #FF003C; --blue: #0088FF; --neon: #DFFF00; }
        body { background: #000; color: #fff; font-family: 'Rajdhani', sans-serif; padding: 0; font-size: 12px; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        * { box-sizing: border-box; }
        
        #loginScreen { position: fixed; inset: 0; background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 99999; }
        .login-box { background: #0a0a0a; border: 2px solid var(--gold); padding: 40px; border-radius: 15px; text-align: center; box-shadow: 0 0 40px rgba(255, 215, 0, 0.2); width: 90%; max-width: 350px; }
        .inp-pin { width: 100%; padding: 15px; font-size: 32px; font-family: 'Teko', sans-serif; text-align: center; letter-spacing: 15px; background: #000; color: var(--gold); border: 1px solid #333; border-radius: 8px; margin-bottom: 20px; }
        .btn-login { width: 100%; padding: 15px; background: var(--gold); color: #000; font-family: 'Rajdhani'; font-size: 20px; font-weight: 900; border: none; border-radius: 8px; cursor: pointer; text-transform: uppercase; }
        
        #adminDashboard { display: none; flex: 1; flex-direction: column; overflow: hidden; }
        .adm-header { display: flex; align-items: center; justify-content: space-between; padding: 15px 20px; background: #0a0a0a; border-bottom: 2px solid var(--gold); }
        
        .tabs { display: flex; background: #111; border-bottom: 1px solid #333; overflow-x: auto; white-space: nowrap; }
        .tab-btn { flex: 1; padding: 12px 15px; text-align: center; font-size: 14px; font-weight: 800; cursor: pointer; color: #fff; transition: 0.3s; letter-spacing: 1px; min-width: 100px; }
        .tab-btn.active { color: var(--gold); border-bottom: 3px solid var(--gold); background: rgba(255, 215, 0, 0.05); }
        .tab-content { display: none; flex: 1; overflow-y: auto; padding: 15px; }
        .tab-content.active { display: block; }
        
        .box { border: 1px solid #333; padding: 15px; margin-bottom: 15px; background: #0a0a0a; border-radius: 8px; }
        h3 { margin: 0 0 15px 0; color: var(--gold); border-bottom: 1px solid #333; padding-bottom: 5px; font-family: 'Orbitron', sans-serif; font-size: 14px; display: flex; justify-content: space-between; align-items:center; }
        
        button { cursor: pointer; padding: 8px 15px; font-weight: bold; font-family: 'Teko'; font-size: 16px; border-radius: 4px; border: none; text-transform: uppercase; }
        .btn-red { background: linear-gradient(45deg, #900, #d00); color: #fff; }
        .btn-green { background: linear-gradient(45deg, #050, #090); color: #fff; }
        .btn-blue { background: linear-gradient(45deg, #005, #009); color: #fff; }
        .btn-gold { background: linear-gradient(45deg, #B8860B, #FFD700); color: #000; }
        .btn-mini { padding: 4px 8px; font-size: 12px; margin: 2px; }
        
        input, select { background: #151515; color: #fff; border: 1px solid #FFF; padding: 10px; border-radius: 4px; font-family: 'Rajdhani'; font-weight:bold; width: 100%; box-sizing: border-box; margin-bottom:5px; text-transform: uppercase; }
        table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 12px; } 
        td, th { border-bottom: 1px solid #222; padding: 8px; } 
        th { color: var(--gold); }
        
        .slot-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; }
        .slot-item { border: 1px solid #333; padding: 10px; background: #050505; text-align: center; border-radius: 6px; min-height: 140px; display: flex; flex-direction: column; justify-content: space-between; }
        .slot-item.active { border-color: var(--gold); background: rgba(255, 215, 0, 0.05); }
        .slot-item.maintenance { border-color: #f00; background: rgba(255, 0, 0, 0.1); }
        
        .glamour-badge { width: 110px; height: 26px; border-radius: 4px; display: flex; align-items: center; background: linear-gradient(135deg, #151515, #050505); border: 1px solid var(--b-color-main); overflow: hidden; margin-top: 5px; }
        .gb-icon { width: 26px; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 11px; background: var(--b-gradient); color: var(--icon-color, #000); border-radius: 3px 0 0 3px; }
        .gb-text { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: 900; color: var(--b-color-main); }
        .b-presiden { --b-color-main: #FFD700; --b-gradient: linear-gradient(135deg, #8B0000, #FF0000); --icon-color: #FFD700; }
        .b-ketum { --b-color-main: #FFDF00; --b-gradient: linear-gradient(135deg, #FFF380, #D4AF37); }
        .b-member { --b-color-main: #D4AF37; --b-gradient: linear-gradient(135deg, #D4AF37, #8B6508); }
        
        #customModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 99999; justify-content: center; align-items: center; } 
        .modal-box { background: #111; border: 1px solid var(--gold); padding: 25px; border-radius: 10px; text-align: center; } 
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .blocked-list { display: flex; flex-direction: column; gap: 5px; margin-top: 10px; }
        .blocked-item { background: #220000; border-left: 3px solid #f00; padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; border-radius: 4px; }

        /* STATISTIK CARDS */
        .stat-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-card { background: #111; border-left: 4px solid var(--gold); padding: 15px; border-radius: 6px; }
        .stat-title { font-size: 10px; color: #fff; letter-spacing: 1px; margin-bottom: 5px; }
        .stat-value { font-family: 'Teko'; font-size: 32px; color: var(--gold); line-height: 1; }
    </style>
</head>
<body>

    <div id="loginScreen"><div class="login-box"><i class="fas fa-shield-alt" style="font-size: 50px; color: var(--gold); margin-bottom: 20px;"></i><h2 style="font-family:'Orbitron'; margin-top:0; color:#fff;">SECURITY CHECK</h2><input type="password" id="adminPin" class="inp-pin" placeholder="â€¢â€¢â€¢â€¢" maxlength="4"><button class="btn-login" onclick="verifyLogin()">AUTHORIZE</button></div></div>

    <div id="adminDashboard">
        <div class="adm-header">
            <div><div style="font-family:'Orbitron'; font-size:18px; color:#fff;">ADMIN PANEL</div><div style="font-size:10px; color:var(--gold);">FC KARTIKA CHANDRA <span id="roleTag" style="background:#333; padding:2px 5px; border-radius:3px; margin-left:5px;"></span></div></div>
            <div style="display:flex; gap:5px;"><button onclick="window.location.href='system.html'" class="btn-gold" style="font-size:12px;"><i class="fas fa-tv"></i></button><button onclick="logout()" class="btn-red" style="font-size:12px;"><i class="fas fa-power-off"></i></button></div>
        </div>

        <div class="tabs">
            <div class="tab-btn active" onclick="switchTab('tabOps', this)">OPS & SYSTEM</div>
            <div class="tab-btn" onclick="switchTab('tabStat', this)">ðŸ“Š STATISTIK</div>
            <div class="tab-btn" id="navDb" onclick="switchTab('tabDb', this)" style="display:none;">DB MEMBER</div>
        </div>

        <div id="tabOps" class="tab-content active">
            <div class="box" style="border-top: 2px solid var(--neon);">
                <h3 style="color:var(--neon);"><i class="fas fa-exclamation-triangle"></i> POP-UP PENGUMUMAN</h3>
                <div style="font-size:10px; color:#fff; margin-bottom:10px;">Pesan ini akan muncul sebagai Pop-Up di tengah layar User.</div>
                <input type="text" id="annInput" placeholder="Ketik teks pengumuman penting di sini...">
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <button class="btn-blue" style="flex:1;" onclick="setAnn(true)">TAYANGKAN POP-UP</button>
                    <button class="btn-red" style="flex:1;" onclick="setAnn(false)">HAPUS (MATIKAN)</button>
                </div>
            </div>

            <div class="box" style="border-top: 2px solid #f00;">
                <h3 style="color:#f00;"><i class="fas fa-tools"></i> KENDALI SLOT RUSAK</h3>
                <div style="font-size:10px; color:#fff; margin-bottom:10px;">Jika nozzle rusak, matikan slot di sini agar user tidak bisa masuk.</div>
                <div id="slotControls" style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr 1fr; gap:5px;"></div>
            </div>

            <div class="box" style="border-top: 2px solid var(--gold);">
                <h3>LIVE MONITORING (5 SLOT)</h3>
                <div class="slot-grid"><div id="slot1" class="slot-item"></div><div id="slot2" class="slot-item"></div><div id="slot3" class="slot-item"></div><div id="slot4" class="slot-item"></div><div id="slot5" class="slot-item"></div></div>
                
                <div style="margin-top:15px; background:#111; padding:10px; border-radius:5px; border:1px solid #333;">
                    <div style="font-size:10px; color:var(--gold); margin-bottom:8px; font-weight:bold;"><i class="fas fa-exchange-alt"></i> PINDAH / TUKAR SLOT</div>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <select id="moveSrc" style="padding:8px; width:auto; flex:1;"><option value="0">SLOT 1</option><option value="1">SLOT 2</option><option value="2">SLOT 3</option><option value="3">SLOT 4</option><option value="4">SLOT 5</option></select>
                        <span style="color:#fff; font-size:16px;">âž¡</span>
                        <select id="moveDest" style="padding:8px; width:auto; flex:1;"><option value="1">SLOT 2</option><option value="2">SLOT 3</option><option value="3">SLOT 4</option><option value="4">SLOT 5</option><option value="0">SLOT 1</option></select>
                        <button onclick="askConfirm('Pindahkan / Tukar Posisi User?', moveSlotUser)" class="btn-blue">GO</button>
                    </div>
                </div>
            </div>

            <div class="box" style="border-top: 2px solid var(--blue);">
                <h3>DAFTAR ANTRIAN <button onclick="askConfirm('RESET URUTAN NOMOR JADI 1?', resetTicketNumbers)" class="btn-red btn-mini">â™» RESET</button></h3>
                <div id="queueTable" style="max-height:300px; overflow-y:auto; margin-bottom:15px; border:1px solid #222;"></div>
                <div style="background:#111; padding:10px; border-radius:5px;">
                    <div style="font-size:10px; color:var(--blue); margin-bottom:5px;">FORCE INPUT (VIP/MANUAL)</div>
                    <div style="display:flex; gap:5px;"><input id="newPlat" placeholder="PLAT"><input id="newNama" placeholder="NAMA"></div>
                    <div style="display:flex; gap:2px; margin-top:5px; flex-wrap:wrap;">
                        <button onclick="manualAdd('queue')" class="btn-green" style="flex:2; min-width: 100px;">+ ANTRIAN</button>
                        <button onclick="manualAdd(0)" class="btn-gold" style="flex:1;">S1</button>
                        <button onclick="manualAdd(1)" class="btn-gold" style="flex:1;">S2</button>
                        <button onclick="manualAdd(2)" class="btn-gold" style="flex:1;">S3</button>
                        <button onclick="manualAdd(3)" class="btn-gold" style="flex:1;">S4</button>
                        <button onclick="manualAdd(4)" class="btn-gold" style="flex:1;">S5</button>
                    </div>
                </div>
            </div>

            <div class="box" style="border-top: 2px solid var(--cyan);">
                <h3 style="color:var(--cyan);"><i class="fas fa-ban"></i> BLOKIR PLAT NOMOR</h3>
                <div style="font-size:10px; color:#fff; margin-bottom:10px;">Plat yang diblokir tidak akan bisa daftar antrian selamanya.</div>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="inpBlock" placeholder="Contoh: B 1234 XY" style="flex:1;">
                    <button onclick="blockPlat()" class="btn-red">BLOKIR</button>
                </div>
                <div id="blockedListContainer" class="blocked-list"></div>
            </div>

            <div class="box" style="border: 1px dashed var(--red);">
                <h3 style="color:var(--red);">EMERGENCY ZONE</h3>
                <div style="display:flex; gap:10px;"><button onclick="askConfirm('KOSONGKAN SEMUA ANTRIAN & SLOT?', hardReset)" class="btn-red" style="flex:1;">ðŸ’€ HARD RESET DATA</button></div>
            </div>
        </div>

        <div id="tabStat" class="tab-content">
            <div class="box" style="border-top: 2px solid var(--green);">
                <h3 style="color:var(--green);"><i class="fas fa-chart-line"></i> LAPORAN HARI INI</h3>
                
                <div class="stat-cards">
                    <div class="stat-card">
                        <div class="stat-title">TOTAL KENDARAAN (CAS)</div>
                        <div class="stat-value" id="statTotal">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">JAM PALING SIBUK</div>
                        <div class="stat-value" id="statPeak" style="color:var(--cyan);">--:--</div>
                    </div>
                </div>

                <div style="font-size:10px; color:#aaa; margin-bottom:5px; font-weight:bold;">DOWNLOAD EXCEL (CSV):</div>
                <div style="display: flex; gap: 5px; margin-bottom: 20px;">
                    <button class="btn-green" style="flex: 1; font-size: 11px;" onclick="downloadExcel('harian')"><i class="fas fa-file-excel"></i> HARIAN</button>
                    <button class="btn-blue" style="flex: 1; font-size: 11px;" onclick="downloadExcel('mingguan')"><i class="fas fa-file-excel"></i> MINGGUAN</button>
                    <button class="btn-gold" style="flex: 1; font-size: 11px;" onclick="downloadExcel('bulanan')"><i class="fas fa-file-excel"></i> BULANAN</button>
                </div>

                <h4 style="color:#fff; margin:0 0 10px 0; font-family:'Rajdhani'; border-bottom:1px solid #333; padding-bottom:5px;">RIWAYAT CHARGING TERAKHIR:</h4>
                <div id="historyTable" style="max-height:400px; overflow-y:auto; border:1px solid #222; background:#111;"></div>
            </div>
        </div>

        <div id="tabDb" class="tab-content">
            <div class="box" style="border-top: 2px solid var(--cyan);">
                <h3 style="color:var(--cyan);">SETTING JABATAN / BADGE</h3>
                <input type="text" id="dbPlat" placeholder="PLAT NOMOR (Spasi)" style="text-transform:uppercase;">
                <input type="text" id="dbNama" placeholder="NAMA LENGKAP" style="text-transform:uppercase;">
                <select id="dbRole" style="color:var(--gold);">
                    <option value="MEMBER">MEMBER BIASA</option>
                    <option value="PRESIDEN MCU">PRESIDEN MCU (Merah Emas)</option>
                    <option value="KETUM">KETUM (Emas)</option>
                    <option value="WAKETUM">WAKETUM (Platinum)</option>
                    <option value="SEKERTARIS">SEKERTARIS (Cyan)</option>
                    <option value="BENDAHARA">BENDAHARA (Hijau)</option>
                    <option value="HUMAS">HUMAS (Ungu)</option>
                    <option value="KREATIF">TIM KREATIF</option>
                    <option value="URC">URC (Merah)</option>
                </select>
                <button onclick="saveMember()" class="btn-blue" style="width:100%; margin-top:5px;">SIMPAN DATA</button>
            </div>
            <div id="memberList"></div>
        </div>
    </div>

    <div id="customModal"><div class="modal-box"><h2 style="margin:0 0 10px 0; color:#fff;">KONFIRMASI</h2><div id="modalText" style="color:#fff; margin-bottom:20px;"></div><div class="modal-btns"><button id="btnYes" class="btn-gold" style="flex:1; padding:10px;">YA</button><button onclick="closeModal()" style="flex:1; padding:10px; background:#333; color:#fff;">BATAL</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, runTransaction, collection, setDoc, getDoc, getDocs, deleteDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDDVYQSjmJEn_RvIUotSxbh8L-ysJMCthk", authDomain: "kartikachandrafc.firebaseapp.com", projectId: "kartikachandrafc", storageBucket: "kartikachandrafc.firebasestorage.app", messagingSenderId: "677704449500", appId: "1:677704449500:web:671df8ae5cf6e66d0b6319" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);
        const mainRef = doc(db, "antrian", "utama"); const membersRef = collection(db, "members");
        const historyRef = collection(db, "riwayatCharging");

        let cachedSlots=[null,null,null,null,null]; let cachedQueue=[]; let disabledSlots=[false,false,false,false,false];
        let blockedPlates = [];

        function cleanStr(s) { return s ? s.replace(/[^A-Z0-9]/gi, '').toUpperCase() : ''; }

        window.verifyLogin = () => {
            const pin = document.getElementById('adminPin').value;
            if(pin === "5588") { sessionStorage.setItem('adm_role', 'ADMIN'); openDashboard('ADMIN'); }
            else if(pin === "9999") { sessionStorage.setItem('adm_role', 'SUPERADMIN'); openDashboard('SUPERADMIN'); }
            else { alert("PIN SALAH!"); }
        };
        window.logout = () => { sessionStorage.removeItem('adm_role'); location.reload(); };

        function openDashboard(role) {
            document.getElementById('loginScreen').style.display = 'none'; document.getElementById('adminDashboard').style.display = 'flex';
            document.getElementById('roleTag').innerText = role;
            if(role === 'SUPERADMIN') { document.getElementById('navDb').style.display = 'block'; loadMembers(); }
            loadStatistikHarian(); 
        }
        if(sessionStorage.getItem('adm_role')) openDashboard(sessionStorage.getItem('adm_role'));

        window.switchTab = (id, el) => { 
            document.querySelectorAll('.tab-content, .tab-btn').forEach(e => e.classList.remove('active')); 
            document.getElementById(id).classList.add('active'); el.classList.add('active'); 
            if(id === 'tabStat') loadStatistikHarian(); 
        };
        
        let cCallback=null; window.askConfirm = (t, cb) => { document.getElementById('modalText').innerText=t; document.getElementById('customModal').style.display='flex'; cCallback=cb; };
        document.getElementById('btnYes').onclick = () => { if(cCallback)cCallback(); closeModal(); }; window.closeModal = () => document.getElementById('customModal').style.display='none';

        function renderAdminBadge(r) {
            if (!r || r==="GUEST") return `<span style="color:#fff;">[NON-MEMBER]</span>`; 
            let css="b-member"; let icon="fa-user"; let txt="MEMBER"; const ru=r.toUpperCase();
            if(ru.includes("PRESIDEN MCU")){css="b-presiden";icon="fa-globe";txt="PRESIDEN MCU";}
            else if(ru.includes("KETUM")){css="b-ketum";icon="fa-crown";txt="KETUM";}
            return `<div class="glamour-badge ${css}"><div class="gb-icon"><i class="fas ${icon}"></i></div><div class="gb-text">${txt}</div></div>`;
        }

        // --- RENDER MONITOR ---
        onSnapshot(mainRef, (snap) => {
            if (!snap.exists()) return; const d = snap.data();
            cachedSlots = d.chargingSlots || [null,null,null,null,null]; while(cachedSlots.length<5)cachedSlots.push(null);
            cachedQueue = d.waitingQueue || []; disabledSlots = d.disabledSlots || [false,false,false,false,false];
            blockedPlates = d.blockedPlates || [];
            
            if(d.announcement) document.getElementById('annInput').value = d.announcement.text || "";
            updateMonitor();
        });

        function updateMonitor() {
            let ctrlHtml = '';
            disabledSlots.forEach((isOff, i) => {
                if(isOff) ctrlHtml += `<button class="btn-red" onclick="askConfirm('Nyalakan Slot ${i+1}?', ()=>toggleSlot(${i}, false))">S${i+1} MATI</button>`;
                else ctrlHtml += `<button class="btn-green" onclick="askConfirm('Matikan Slot ${i+1}? (Bila Rusak)', ()=>toggleSlot(${i}, true))">S${i+1} AKTIF</button>`;
            });
            document.getElementById('slotControls').innerHTML = ctrlHtml;

            cachedSlots.forEach((s, i) => {
                const el = document.getElementById(`slot${i+1}`);
                if (disabledSlots[i]) {
                    el.className = "slot-item maintenance";
                    el.innerHTML = `<div style="color:#f00; font-weight:bold; margin:auto;"><i class="fas fa-times-circle" style="font-size:30px;"></i><br><br>MAINTENANCE</div>`;
                } else if(s) {
                    el.className = "slot-item active";
                    el.innerHTML = `<div><div style="font-size:24px; font-family:'Teko'; color:#fff; line-height:1;">${s.plat}</div><div style="font-size:10px; color:#fff;">${s.userName}</div>${renderAdminBadge(s.role)}</div><div style="display:grid; gap:4px; margin-top:10px;"><button class="btn-red btn-mini" onclick="askConfirm('Stop / Keluarkan?', ()=>forceStop(${i}))">STOP</button><button class="btn-blue btn-mini" onclick="askConfirm('Kembalikan ke Antrian?', ()=>kickToQueue(${i}))">KE ANTRIAN</button></div>`;
                } else { el.className = "slot-item"; el.innerHTML = `<div style="color:#fff; margin:auto; font-family:'Orbitron'; font-size:16px;">KOSONG</div>`; }
            });

            let h = `<table><tr><th width="20">#</th><th>USER</th><th width="120">KE SLOT</th><th width="40">AKSI</th></tr>`;
            if(cachedQueue.length === 0) h += `<tr><td colspan="4" style="text-align:center; padding:15px; color:#fff;">TIDAK ADA ANTRIAN</td></tr>`;
            cachedQueue.forEach((q, idx) => {
                h += `<tr><td style="font-size:16px; font-weight:bold; color:var(--cyan)">${q.qNo}</td><td><b style="color:#fff; font-size:16px; font-family:'Teko';">${q.plat}</b><br><span style="color:#fff;">${q.userName}</span><br>${renderAdminBadge(q.role)}</td><td><div style="display:flex; gap:2px; flex-wrap:wrap;">`;
                for(let i=0; i<5; i++) { h += `<button class="${disabledSlots[i]?'btn-red':'btn-gold'} btn-mini" onclick="forceToSlot('${q.plat}', ${i})">S${i+1}</button>`; }
                h += `</div></td><td><div style="display:flex; gap:2px;"><button class="btn-blue btn-mini" onclick="switchQueue(${idx}, -1)">â¬†</button><button class="btn-blue btn-mini" onclick="switchQueue(${idx}, 1)">â¬‡</button><button class="btn-red btn-mini" onclick="askConfirm('Hapus Antrian?', ()=>delQueue('${q.plat}'))">X</button></div></td></tr>`;
            });
            document.getElementById('queueTable').innerHTML = h + `</table>`;

            let blockHtml = '';
            if(blockedPlates.length === 0) blockHtml = '<div style="color:#fff; font-size:10px; text-align:center;">TIDAK ADA PLAT DIBLOKIR</div>';
            else {
                blockedPlates.forEach(p => {
                    blockHtml += `<div class="blocked-item"><span style="font-family:'Teko'; font-size:18px; color:#fff;">${p}</span> <button class="btn-green btn-mini" onclick="unblockPlat('${p}')">BUKA BLOKIR</button></div>`;
                });
            }
            document.getElementById('blockedListContainer').innerHTML = blockHtml;
        }

        // --- SISTEM STATISTIK HARIAN & TABEL HISTORY ---
        async function loadStatistikHarian() {
            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0).getTime();
            const endOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59).getTime();

            try {
                const q = query(historyRef, orderBy("finishTime", "desc"));
                const querySnapshot = await getDocs(q);
                
                let totalHariIni = 0;
                let jamHitung = new Array(24).fill(0);
                let tableHtml = `<table><tr><th>WAKTU</th><th>PLAT</th><th>NAMA</th><th>AKSI</th></tr>`;
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    let timeVal = data.finishTime;
                    if(data.finishTime && data.finishTime.toDate) timeVal = data.finishTime.toDate().getTime();
                    else if(data.startTime) timeVal = data.startTime;

                    if(timeVal >= startOfDay && timeVal <= endOfDay) {
                        totalHariIni++;
                        const dateObj = new Date(timeVal);
                        const jam = dateObj.getHours();
                        const menit = String(dateObj.getMinutes()).padStart(2, '0');
                        jamHitung[jam]++;

                        tableHtml += `<tr>
                            <td style="color:var(--cyan); font-weight:bold;">${jam}:${menit}</td>
                            <td style="font-family:'Teko'; font-size:16px;">${data.plat || '-'}</td>
                            <td>${data.userName || '-'}</td>
                            <td><span class="btn-mini ${data.action === 'STOP' ? 'btn-red' : 'btn-green'}" style="font-size:8px;">${data.action || 'SELESAI'}</span></td>
                        </tr>`;
                    }
                });

                if(totalHariIni === 0) tableHtml += `<tr><td colspan="4" style="text-align:center; color:#fff;">Belum ada riwayat hari ini.</td></tr>`;
                tableHtml += `</table>`;

                let peakHour = 0; let maxCount = 0;
                for(let i=0; i<24; i++) { if(jamHitung[i] > maxCount) { maxCount = jamHitung[i]; peakHour = i; } }
                let peakText = maxCount > 0 ? `${String(peakHour).padStart(2,'0')}:00 - ${String(peakHour+1).padStart(2,'0')}:00` : "--:--";

                document.getElementById('statTotal').innerText = totalHariIni;
                document.getElementById('statPeak').innerText = peakText;
                document.getElementById('historyTable').innerHTML = tableHtml;

            } catch(e) { console.log("Gagal memuat statistik:", e); }
        }

        // --- SISTEM DOWNLOAD EXCEL (HARIAN / MINGGUAN / BULANAN) ---
        window.downloadExcel = async (type) => {
            const now = new Date();
            let startTime, endTime, fileNamePrefix;

            if (type === 'harian') {
                startTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0).getTime();
                endTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59).getTime();
                fileNamePrefix = 'Harian';
            } else if (type === 'mingguan') {
                // 7 Hari Terakhir
                startTime = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 6, 0, 0, 0).getTime();
                endTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59).getTime();
                fileNamePrefix = 'Mingguan';
            } else if (type === 'bulanan') {
                // Bulan Ini (Tgl 1 sampai akhir bulan)
                startTime = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0).getTime();
                endTime = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59).getTime(); 
                fileNamePrefix = 'Bulanan';
            }

            try {
                // Alert popup agar admin tahu sistem sedang memproses
                alert(`Mengumpulkan data ${fileNamePrefix}... Klik OK untuk melanjutkan.`);

                const q = query(historyRef, orderBy("finishTime", "desc"));
                const querySnapshot = await getDocs(q);
                
                let csvContent = "data:text/csv;charset=utf-8,Tanggal,Jam,Plat Nomor,Nama Pengendara,Sisa Baterai Awal,Status\n";
                let dataCount = 0;

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    let timeVal = data.finishTime;
                    if(data.finishTime && data.finishTime.toDate) timeVal = data.finishTime.toDate().getTime();
                    else if(data.startTime) timeVal = data.startTime;

                    if(timeVal >= startTime && timeVal <= endTime) {
                        dataCount++;
                        const dateObj = new Date(timeVal);
                        const tgl = dateObj.toLocaleDateString('id-ID');
                        const jam = `${String(dateObj.getHours()).padStart(2, '0')}:${String(dateObj.getMinutes()).padStart(2, '0')}`;
                        const plat = data.plat || '-';
                        const nama = data.userName || '-';
                        const batre = data.batreSisa || '-';
                        const status = data.action || 'SELESAI';
                        
                        csvContent += `${tgl},${jam},${plat},${nama},${batre},${status}\n`;
                    }
                });

                if(dataCount === 0) {
                    return alert(`Tidak ada riwayat charging untuk laporan ${fileNamePrefix} ini.`);
                }

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
                
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `Laporan_KC_${fileNamePrefix}_${dateStr}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch(e) {
                console.log("Error export:", e);
                alert("Gagal mengunduh data!");
            }
        };

        // --- SISTEM POP-UP PENGUMUMAN ---
        window.setAnn = (isActive) => {
            const txt = document.getElementById('annInput').value;
            if(isActive && !txt) return alert("Isi teks pengumuman dulu!");
            const annId = Date.now().toString(); 
            runTransaction(db, async(t) => { t.update(mainRef, { announcement: { text: txt, active: isActive, id: annId } }); }).then(() => alert(isActive ? "Pop-Up Pengumuman DITAYANGKAN ke semua User!" : "Pop-Up Pengumuman DIMATIKAN."));
        };

        // --- SISTEM BLOKIR ---
        window.blockPlat = () => {
            let p = document.getElementById('inpBlock').value.toUpperCase().trim();
            if(!p) return alert("Isi plat nomor dulu!");
            runTransaction(db, async(t) => {
                const d = (await t.get(mainRef)).data();
                let b = d.blockedPlates || [];
                if(!b.includes(p)) b.push(p);
                t.update(mainRef, { blockedPlates: b });
            }).then(() => { document.getElementById('inpBlock').value = ''; alert(`Plat ${p} berhasil DIBLOKIR!`); });
        };
        window.unblockPlat = (p) => {
            runTransaction(db, async(t) => {
                const d = (await t.get(mainRef)).data();
                let b = d.blockedPlates || [];
                b = b.filter(x => x !== p);
                t.update(mainRef, { blockedPlates: b });
            });
        };

        window.moveSlotUser = () => {
            const s1 = parseInt(document.getElementById('moveSrc').value);
            const s2 = parseInt(document.getElementById('moveDest').value);
            if(s1 === s2) return alert("Pilih Slot Tujuan yang berbeda!");
            runTransaction(db, async(t) => {
                const d = (await t.get(mainRef)).data();
                if((d.disabledSlots||[])[s1] || (d.disabledSlots||[])[s2]) throw "Tidak bisa memindahkan ke/dari Slot yang sedang Maintenance!";
                let slots = d.chargingSlots || [null,null,null,null,null];
                const temp = slots[s1]; slots[s1] = slots[s2]; slots[s2] = temp;
                t.update(mainRef, { chargingSlots: slots });
            }).catch(e => alert(e));
        };

        window.toggleSlot = (i, turnOff) => {
            runTransaction(db, async(t) => {
                const d = (await t.get(mainRef)).data();
                let dis = d.disabledSlots || [false,false,false,false,false];
                dis[i] = turnOff;
                if(turnOff && d.chargingSlots && d.chargingSlots[i]) {
                    const u = d.chargingSlots[i];
                    addDoc(historyRef, {...u, finishTime: new Date(), action: "KICKED_MAINTENANCE"});
                    d.chargingSlots[i] = null; 
                }
                t.update(mainRef, { disabledSlots: dis, chargingSlots: d.chargingSlots });
            });
        };

        window.manualAdd = async (target) => {
            const p = document.getElementById('newPlat').value.trim().toUpperCase(); const n = document.getElementById('newNama').value.trim().toUpperCase();
            if(!p) return alert("Plat Nomor Wajib!");
            let userRole = "GUEST"; try { let m = await getDoc(doc(db, "members", cleanStr(p))); if(m.exists()) userRole = m.data().role || "MEMBER"; } catch(e) {}
            runTransaction(db, async(t) => {
                const d = (await t.get(mainRef)).data();
                if([...(d.chargingSlots||[]), ...(d.waitingQueue||[])].some(u => u && u.plat === p)) throw "User sudah ada!";
                const newNo = (d.lastTicket||0)+1; const u = { plat:p, userName:n||"MANUAL", qNo:newNo, entryTime:Date.now(), role: userRole };
                if(target === 'queue') d.waitingQueue.push(u); 
                else { 
                    if((d.disabledSlots||[])[target]) throw "SLOT DALAM PERBAIKAN!";
                    if(d.chargingSlots[target]) throw "Slot Penuh!"; 
                    u.startTime = Date.now(); d.chargingSlots[target] = u; 
                }
                t.update(mainRef, { waitingQueue: d.waitingQueue, chargingSlots: d.chargingSlots, lastTicket: newNo });
            }).then(() => { document.getElementById('newPlat').value = ''; document.getElementById('newNama').value = ''; loadStatistikHarian(); }).catch(e => alert(e));
        };

        window.forceToSlot = (plat, slotIdx) => runTransaction(db, async(t) => { const d = (await t.get(mainRef)).data(); if((d.disabledSlots||[])[slotIdx]) throw "SLOT RUSAK/MAINTENANCE!"; if(d.chargingSlots[slotIdx]) throw "SLOT TERISI!"; const qIdx = d.waitingQueue.findIndex(x => x.plat === plat); if(qIdx === -1) throw "Data hilang."; const u = d.waitingQueue.splice(qIdx, 1)[0]; u.startTime = Date.now(); d.chargingSlots[slotIdx] = u; t.update(mainRef, { chargingSlots: d.chargingSlots, waitingQueue: d.waitingQueue }); }).catch(e => alert(e));
        window.forceStop = (i) => runTransaction(db, async(t) => { const d = (await t.get(mainRef)).data(); const u = d.chargingSlots[i]; if(u) addDoc(historyRef, {...u, finishTime: new Date(), action: "STOP_BY_ADMIN"}); d.chargingSlots[i] = null; t.update(mainRef, { chargingSlots: d.chargingSlots }); }).then(() => loadStatistikHarian());
        window.kickToQueue = (i) => runTransaction(db, async(t) => { const d = (await t.get(mainRef)).data(); const u = d.chargingSlots[i]; if(u) { d.chargingSlots[i] = null; delete u.startTime; d.waitingQueue.unshift(u); t.update(mainRef, { chargingSlots: d.chargingSlots, waitingQueue: d.waitingQueue }); } });
        window.resetTicketNumbers = () => runTransaction(db, async(t) => { const d=(await t.get(mainRef)).data(); d.waitingQueue.forEach((q,index)=>q.qNo=index+1); t.update(mainRef, {waitingQueue: d.waitingQueue, lastTicket: d.waitingQueue.length}); });
        window.switchQueue = (idx, dir) => runTransaction(db, async(t) => { const d = (await t.get(mainRef)).data(); let q = d.waitingQueue; const tgt = idx + dir; if(tgt >= 0 && tgt < q.length) { [q[idx], q[tgt]] = [q[tgt], q[idx]]; t.update(mainRef, { waitingQueue: q }); } });
        window.delQueue = (p) => runTransaction(db, async(t) => { const d = (await t.get(mainRef)).data(); t.update(mainRef, { waitingQueue: d.waitingQueue.filter(x => x.plat !== p) }); });
        window.hardReset = () => runTransaction(db, async(t) => { t.update(mainRef, { chargingSlots: [null,null,null,null,null], waitingQueue: [], lastTicket: 0 }); });

        // --- DB MEMBER ---
        async function loadMembers() {
            const div = document.getElementById('memberList'); div.innerHTML = 'Loading...';
            const s = await getDocs(membersRef); let h = '';
            s.forEach(d => { const m=d.data(); h += `<div style="background:#111; padding:10px; margin-bottom:5px; border-left:3px solid var(--gold);"><b style="color:#fff; font-family:'Teko'; font-size:18px;">${m.plat}</b> - ${m.nama} ${renderAdminBadge(m.role)}<button style="float:right; background:red; color:#fff; border:none; padding:5px; cursor:pointer;" onclick="deleteMember('${d.id}')">X</button></div>`; });
            div.innerHTML = h || '<div style="color:#fff;text-align:center;">KOSONG</div>';
        }
        window.saveMember = async () => {
            const p=document.getElementById('dbPlat').value.toUpperCase(); const n=document.getElementById('dbNama').value.toUpperCase(); const r=document.getElementById('dbRole').value;
            if(!p||!n)return alert("Isi data!"); await setDoc(doc(db,"members",cleanStr(p)),{plat:p,nama:n,role:r}); 
            runTransaction(db, async(t)=>{ const d=(await t.get(mainRef)).data(); let u=0; if(d.chargingSlots)d.chargingSlots.forEach(s=>{if(s&&cleanStr(s.plat)===cleanStr(p)){s.role=r;u=1;}}); if(d.waitingQueue)d.waitingQueue.forEach(q=>{if(q&&cleanStr(q.plat)===cleanStr(p)){q.role=r;u=1;}}); if(u)t.update(mainRef,{chargingSlots:d.chargingSlots,waitingQueue:d.waitingQueue}); });
            alert("Disimpan!"); document.getElementById('dbPlat').value=''; document.getElementById('dbNama').value=''; loadMembers();
        };
        window.deleteMember = async (id) => { if(confirm("Hapus?")) { await deleteDoc(doc(db,"members",id)); loadMembers(); } };
    </script>
</body>
</html>
