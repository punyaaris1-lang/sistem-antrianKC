<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAKA - PLAN TRIP KARTIKA CHANDRA</title>
    
    <script>
        const CURRENT_VERSION = "3.0_Tactical_Planner_UI"; 
        if (localStorage.getItem("app_version_plan") !== CURRENT_VERSION) {
            if (window.caches) { caches.keys().then((k) => Promise.all(k.map((key) => caches.delete(key)))); }
            localStorage.setItem("app_version_plan", CURRENT_VERSION);
            window.location.reload(true);
        }
    </script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:ital,wght@0,700;0,900;1,700;1,900&family=Rajdhani:wght@500;600;700;800;900&family=Teko:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* === TEMA TACTICAL LUXURY (NEON LIME + TITANIUM) === */
        :root {
            --kc-lime: #D4FF00;       
            --kc-silver: #E2E8F0;
            --danger: #FF003C;
            
            --metal-dark: linear-gradient(145deg, #1A1D24 0%, #0D0F12 100%);
            --metal-light: linear-gradient(145deg, #2D333B 0%, #1E2229 100%);
            --carbon-bg: repeating-linear-gradient(45deg, #050608 0, #050608 2px, #0a0b0e 2px, #0a0b0e 6px);
            
            --border-metal: 1px solid rgba(255,255,255,0.08);
            --shadow-3d: 10px 10px 30px rgba(0,0,0,0.8), -2px -2px 10px rgba(255,255,255,0.03);
            --inner-bevel: inset 1px 1px 2px rgba(255,255,255,0.1), inset -1px -1px 2px rgba(0,0,0,0.5);

            --font-head: 'Orbitron', sans-serif;
            --font-tech: 'Rajdhani', sans-serif;
            --font-num: 'Teko', sans-serif;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; padding: 0 0 110px 0; 
            font-family: var(--font-tech); 
            background-color: #030405;
            background-image: 
                radial-gradient(circle at 100% 0%, rgba(212, 255, 0, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 0% 100%, rgba(255, 255, 255, 0.03) 0%, transparent 40%),
                var(--carbon-bg);
            color: #fff; overflow-x: hidden;
        }
        
        /* --- HEADER --- */
        .header { text-align: center; padding-top: 35px; margin-bottom: 20px; position: relative; z-index: 5; } 
        .main-title { font-family: var(--font-head); font-style: italic; font-weight: 900; font-size: clamp(22px, 7.5vw, 34px); white-space: nowrap; color: #fff; letter-spacing: 1px; text-transform: uppercase; line-height: 1; margin: 0; text-shadow: 0 0 10px rgba(255,255,255,0.3); background: linear-gradient(180deg, #FFFFFF 0%, #D0D5DD 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .sub-title { font-family: var(--font-tech); font-weight: 800; font-size: clamp(10px, 4vw, 13px); white-space: nowrap; color: var(--kc-lime); letter-spacing: 4px; text-transform: uppercase; margin-top: 8px; text-shadow: 0 0 8px rgba(212,255,0,0.3); }

        .tiktok-badge { display: inline-flex; align-items: center; justify-content: center; gap: 6px; margin-top: 15px; padding: 6px 16px; background: var(--metal-dark); border: var(--border-metal); border-radius: 20px; color: #fff; text-decoration: none; font-family: var(--font-tech); font-weight: 800; font-size: 11px; letter-spacing: 1px; box-shadow: var(--shadow-3d); transition: 0.3s; }
        .tiktok-badge:active { transform: scale(0.95); }
        .tiktok-badge i { color: var(--kc-lime); font-size: 14px; text-shadow: 0 0 10px var(--kc-lime); }

        /* --- CONTAINER & INPUTS --- */
        .container { padding: 0 20px; position: relative; z-index: 5;}
        #db-status { text-align: center; font-size: 11px; color: #8892B0; margin-bottom: 20px; font-family: var(--font-head); letter-spacing: 2px; font-weight: bold; }
        
        .input-group { position: relative; margin-bottom: 15px; }
        .input-icon { position: absolute; left: 15px; top: 16px; color: var(--kc-lime); font-family: var(--font-head); font-style: italic; font-size: 10px; z-index: 2; font-weight: 900; letter-spacing: 1px;}
        
        .form-control { width: 100%; padding: 14px 10px 14px 70px; background: var(--metal-dark); border: var(--border-metal); border-radius: 8px; color: #fff; font-family: var(--font-tech); font-weight: 700; font-size: 16px; box-sizing: border-box; transition: 0.3s; text-transform: uppercase; box-shadow: var(--inner-bevel); }
        .form-control:focus { border-color: var(--kc-lime); outline: none; background: #000; box-shadow: 0 0 15px rgba(212,255,0,0.2); }
        .form-control::placeholder { color: #555; font-weight: 600; }
        .form-control.gps-active { border-color: var(--kc-lime); color: var(--kc-lime); background: rgba(212, 255, 0, 0.05); }

        .gps-trigger { position: absolute; right: 10px; top: 10px; background: rgba(212, 255, 0, 0.1); border: 1px solid var(--kc-lime); color: var(--kc-lime); width: 34px; height: 34px; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .gps-trigger:active { background: var(--kc-lime); color: #000; }
        
        .btn-add { width: 100%; background: rgba(255,255,255,0.02); border: 1px dashed #555; color: #aaa; border-radius: 8px; padding: 12px; font-family: var(--font-tech); font-weight: 800; font-size: 14px; cursor: pointer; margin-bottom: 20px; transition: 0.2s; letter-spacing: 1px;}
        .btn-add:active { background: rgba(212, 255, 0, 0.1); color: var(--kc-lime); border-color: var(--kc-lime); }

        /* --- ACTION BUTTON TACTICAL --- */
        .btn-action { width: 100%; background: linear-gradient(180deg, #D4FF00 0%, #8DAA00 100%); border: none; color: #000; padding: 20px; position: relative; font-family: var(--font-logo); font-style: italic; font-weight: 900; font-size: 20px; letter-spacing: 2px; text-transform: uppercase; cursor: pointer; clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px); box-shadow: inset 2px 2px 2px rgba(255,255,255,0.5), inset -2px -2px 5px rgba(0,0,0,0.5); transition: 0.1s; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 15px; filter: drop-shadow(0 10px 15px rgba(212, 255, 0, 0.2)); }
        .btn-action:active { transform: translateY(4px); background: linear-gradient(180deg, #8DAA00 0%, #5E7300 100%); box-shadow: inset 2px 2px 8px rgba(0,0,0,0.8); filter: drop-shadow(0 0px 0px transparent);}

        /* --- RESULTS AREA --- */
        .route-card { background: var(--metal-dark); border: var(--border-metal); margin-top: 30px; padding: 20px; border-radius: 12px; position: relative; box-shadow: var(--shadow-3d); }
        .route-card.aman { border-left: 4px solid var(--kc-lime); }
        .route-card.nekat { border-left: 4px solid var(--danger); }
        
        .card-title { font-family: var(--font-head); font-style: italic; font-weight: 900; font-size: 16px; color: #fff; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 12px; letter-spacing: 1px;}
        .badge { font-family: var(--font-tech); font-weight: 900; padding: 4px 10px; font-size: 11px; border-radius: 4px; color: #000; letter-spacing: 1px; font-style: normal;}
        .badge.aman { background: var(--kc-lime); box-shadow: 0 0 10px rgba(212, 255, 0, 0.4); }
        .badge.nekat { background: var(--danger); color: #fff; box-shadow: 0 0 10px rgba(255, 0, 60, 0.4); }

        .timeline { position: relative; padding-left: 25px; border-left: 2px dashed #444; margin-left: 10px; }
        .t-item { position: relative; margin-bottom: 25px; }
        .t-dot { position: absolute; left: -32px; top: 5px; width: 14px; height: 14px; background: #000; border: 2px solid var(--kc-lime); border-radius: 50%; box-shadow: 0 0 10px rgba(212,255,0,0.5); }
        .t-info { background: rgba(255,255,255,0.02); padding: 15px; border: 1px solid rgba(255,255,255,0.05); border-radius: 8px; box-shadow: var(--inner-bevel);}
        .t-name { font-family: var(--font-tech); font-weight: 900; font-size: 18px; color: #fff; line-height: 1.2; text-transform: uppercase; letter-spacing: 1px;}
        .t-meta { font-size: 12px; color: #8892B0; display: flex; justify-content: space-between; align-items: center; margin-top: 8px; font-family: var(--font-tech); font-weight: 800; }
        .t-bat { font-weight: 600; font-family: var(--font-num); font-size: 24px; line-height: 1;}
        
        .bat-ok { color: var(--kc-lime); }
        .bat-low { color: var(--danger); animation: blink 1s infinite; text-shadow: 0 0 10px var(--danger);}

        .dest-info { margin-top: 20px; padding: 15px; background: rgba(212, 255, 0, 0.05); border: 1px solid var(--kc-lime); border-radius: 8px; box-shadow: inset 0 0 20px rgba(212,255,0,0.05);}
        .dest-label { font-size: 10px; color: var(--kc-lime); letter-spacing: 2px; font-weight: 900; margin-bottom: 5px; font-family: var(--font-head); font-style: italic;}
        .dest-val { font-family: var(--font-num); font-weight: 600; font-size: 26px; color: #fff; text-transform: uppercase; line-height: 1; margin-bottom: 5px;}

        #map { height: 350px; width: 100%; background: #111; border: var(--border-metal); margin-top: 25px; border-radius: 12px; filter: grayscale(20%) contrast(120%);}
        
        /* --- ANIMASI SCANNING LOGO (LOADING SCREEN) --- */
        #loading-overlay { position: fixed; inset: 0; background: rgba(3,4,5,0.9); z-index: 99999; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px);}
        .scanner-container { position: relative; width: 150px; height: 150px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; }
        .scanner-logo { font-size: 80px; color: #222; }
        .scanline { position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: var(--kc-lime); box-shadow: 0 0 15px 2px var(--kc-lime); opacity: 0; }
        .loading-text { font-family: var(--font-head); font-style: italic; font-weight:900; color: var(--kc-lime); font-size: 14px; letter-spacing: 4px; animation: blink 1s infinite; text-shadow: 0 0 10px var(--kc-lime);}
        
        .scanning-active .scanline { animation: scan-anim 2s linear infinite; opacity: 1;}
        .scanning-active .scanner-logo { animation: logo-reveal 2s linear infinite; }

        @keyframes scan-anim { 0% { top: 0%; } 50% { top: 100%; } 100% { top: 0%; } }
        @keyframes logo-reveal { 0%, 100% { color: #222; filter: none; } 50% { color: var(--kc-lime); filter: drop-shadow(0 0 15px var(--kc-lime)); } }

        /* --- DOCK NAV BAWAH --- */
        .dock-container { position: fixed; bottom: 0; left: 0; width: 100%; height: 80px; background: rgba(5, 5, 5, 0.98); border-top: 1px solid rgba(212, 255, 0, 0.3); display: grid; grid-template-columns: 1fr 1fr 1fr; align-items: center; z-index: 20000; box-shadow: 0 -5px 20px rgba(212, 255, 0, 0.05);}
        .nav-item { text-decoration: none; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #fff; opacity: 0.5; height: 100%; }
        .nav-item.active { opacity: 1; color: var(--kc-lime); text-shadow: 0 0 15px rgba(212, 255, 0, 0.4); }
        .nav-item.center-btn { transform: translateY(-30px); opacity: 1; }
        .center-icon-box { width: 65px; height: 65px; background: #000; border: 2px solid var(--kc-lime); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 26px; color: var(--kc-lime); position: relative; box-shadow: 0 0 15px rgba(212, 255, 0, 0.3);}
        .nav-text { font-family: var(--font-head); font-style: italic; font-size: 9px; font-weight: 900; letter-spacing: 1.5px; margin-top: 6px; text-transform: uppercase;}

        @keyframes blink { 0%,100% {opacity:1} 50% {opacity:0.4} }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="scanner-container">
            <i class="fas fa-route scanner-logo"></i>
            <div class="scanline"></div>
        </div>
        <div class="loading-text" id="loadingText">ANALISA RUTE SATELIT...</div>
    </div>

    <div class="header">
        <h1 class="main-title">TACTICAL PLANNER</h1>
        <div class="sub-title">MAKA LINTAS KARTIKA CHANDRA</div><br>
        
        <a href="https://www.tiktok.com/@maka_ojol?_r=1&_t=ZS-93whYgrpbGe" target="_blank" class="tiktok-badge">
            <i class="fab fa-tiktok"></i> @maka_ojol
        </a>
    </div>

    <div class="container">
        <div id="db-status">MENGHUBUNGKAN SATELIT...</div>

        <div id="waypoints">
            <div class="input-group">
                <div class="input-icon">START</div>
                <input type="text" id="start-input" class="form-control loc-input" placeholder="LOKASI AWAL (Tap Ikon)">
                <div class="gps-trigger" onclick="useCurrentLocation()"><i class="fas fa-crosshairs"></i></div>
            </div>

            <div class="input-group">
                <div class="input-icon">END</div>
                <input type="text" class="form-control loc-input" placeholder="TUJUAN AKHIR">
            </div>
        </div>
        
        <button class="btn-add" onclick="addStop()">+ TAMBAH TITIK SINGGAH</button>

        <div class="input-group">
            <div class="input-icon" style="font-size: 16px; top: 12px;"><i class="fas fa-bolt"></i></div>
            <input type="number" id="battery" class="form-control" value="100" placeholder="BATERAI AWAL (%)" style="color:var(--kc-lime); font-family:var(--font-num); font-size:28px; padding-top:8px; padding-bottom:8px;">
        </div>

        <button class="btn-action" onclick="calculateRoute()">ANALISA RUTE</button>

        <div id="result-area"></div>
        <div id="map" style="display:none;"></div>
    </div>

    <div class="dock-container">
        <a href="lokasifc.html" class="nav-item">
            <i class="fas fa-map-marked-alt" style="font-size:20px; margin-bottom:2px;"></i><span class="nav-text">PETA FC</span>
        </a>
        <a href="antrian.html" class="nav-item center-btn">
            <div class="center-icon-box"><i class="fas fa-qrcode"></i></div>
            <span class="nav-text" style="color:var(--kc-lime);">ANTRIAN</span>
        </a>
        <div class="nav-item active">
            <i class="fas fa-route" style="font-size:20px; margin-bottom:2px;"></i><span class="nav-text">TRIP PLAN</span>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const map = L.map('map').setView([-6.2, 106.8], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, opacity: 1 }).addTo(map);
        
        let fcLocations = [];
        let mapLayers = L.layerGroup().addTo(map);
        
        const URL_LOKASI = "https://docs.google.com/spreadsheets/d/1EJOTMMfGpBMFPqR0LzbMbh7tZUcTCZld4x387OO9aJM/export?format=csv";

        let gpsStartCoords = null; 

        window.onload = async function() {
            try {
                const txtLoc = await fetch(URL_LOKASI).then(r=>r.text());
                const rows = txtLoc.split('\n').slice(1);
                
                rows.forEach(r => {
                    const c = r.split(',');
                    
                    let name = c[0] ? c[0].replace(/"/g, '').trim() : "STASIUN FC";
                    let latStr = c[4] ? c[4].replace(/"/g, '').replace(',', '.') : '';
                    let lngStr = c[5] ? c[5].replace(/"/g, '').replace(',', '.') : '';
                    
                    let latVal = parseFloat(latStr);
                    let lngVal = parseFloat(lngStr);
                    
                    if(c.length < 5 || isNaN(latVal) || isNaN(lngVal)) return;

                    fcLocations.push({ name: name, lat: latVal, lng: lngVal });
                });
                document.getElementById('db-status').innerHTML = 'SYSTEM ONLINE - ' + fcLocations.length + ' FC DETECTED';
                document.getElementById('db-status').style.color = 'var(--kc-lime)';
            } catch(e) {
                document.getElementById('db-status').innerHTML = 'GAGAL TERHUBUNG KE SATELIT';
                document.getElementById('db-status').style.color = 'var(--danger)';
            }
        };

        async function useCurrentLocation() {
            const input = document.getElementById('start-input');
            if(!navigator.geolocation) return alert("Browser tidak support GPS");
            
            input.value = "MENCARI LOKASI...";
            input.classList.remove('gps-active');

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const { latitude, longitude } = pos.coords;
                gpsStartCoords = { lat: latitude, lon: longitude, name: "LOKASI SAYA" };
                
                try {
                    const addr = await getAddressFromCoords(latitude, longitude);
                    gpsStartCoords.name = addr;
                    input.value = "üìç " + addr; 
                } catch(e) {
                    input.value = "[ GPS TERSAMBUNG ]";
                }
                input.classList.add('gps-active'); 
            }, (err) => {
                alert("Gagal mengambil lokasi GPS. Pastikan GPS nyala.");
                input.value = "";
            }, { enableHighAccuracy: true });
        }

        async function getAddressFromCoords(lat, lon) {
            const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
            const d = await r.json();
            return d.display_name.split(',').slice(0, 3).join(',');
        }

        function addStop() {
            const div = document.createElement('div');
            div.className = 'input-group';
            div.innerHTML = `<div class="input-icon" style="top:16px;">STOP</div><input type="text" class="form-control loc-input" placeholder="NAMA KOTA / JALAN"><div style="position:absolute; right:12px; top:12px; font-size:18px; color:var(--danger); cursor:pointer;" onclick="this.parentElement.remove()"><i class="fas fa-times-circle"></i></div>`;
            document.getElementById('waypoints').insertBefore(div, document.getElementById('waypoints').lastElementChild);
        }

        // FUNGSI ANIMASI SCANNING
        function triggerScanning() {
            const screen = document.getElementById('loading-overlay');
            screen.style.display = 'flex';
            screen.classList.add('scanning-active');
        }
        function stopScanning() {
            const screen = document.getElementById('loading-overlay');
            screen.classList.remove('scanning-active');
            screen.style.display = 'none';
        }

        async function calculateRoute() {
            const inputs = document.querySelectorAll('.loc-input');
            const batStart = parseInt(document.getElementById('battery').value);
            const resArea = document.getElementById('result-area');
            const mapDiv = document.getElementById('map');
            
            let inputTexts = [];
            inputs.forEach(i => { 
                let val = i.value.trim();
                if(val.startsWith("üìç ")) val = val.substring(2); 
                if(val) inputTexts.push(val); 
            });
            
            if(inputTexts.length < 2) return alert("MASUKKAN LOKASI AWAL & TUJUAN!");

            triggerScanning(); // UI Baru Loading
            mapLayers.clearLayers();
            resArea.innerHTML = '';
            mapDiv.style.display = 'none';

            try {
                let points = [];
                for(let i=0; i<inputTexts.length; i++) {
                    const txt = inputTexts[i];
                    if(i === 0 && gpsStartCoords && (txt === gpsStartCoords.name || txt === "[ GPS TERSAMBUNG ]")) {
                        points.push(gpsStartCoords);
                    } else {
                        const c = await getGeo(txt);
                        if(!c) throw new Error(`LOKASI TIDAK DITEMUKAN: ${txt}`);
                        points.push(c);
                    }
                }

                const directRoute = await getOSRM(points);
                const totalDistKm = directRoute.distance / 1000;
                const needed = Math.ceil(totalDistKm);
                const finalBat = batStart - needed;

                const destPoint = points[points.length-1];
                const nearestFromDest = findNearestFC(destPoint);

                if (finalBat >= 10) {
                    renderResult('aman', 'RUTE LANGSUNG (AMAN)', points, batStart, null, nearestFromDest);
                    drawMap(points, '#0088FF'); 
                } else {
                    const bestCharger = await findBestCharger(points[0], points[points.length-1], batStart);
                    if (bestCharger) {
                        renderResult('aman', 'RUTE VIA CHARGER', points, batStart, bestCharger, nearestFromDest);
                        drawComplexRoute(points[0], bestCharger, points[points.length-1]);
                    } else {
                        renderResult('nekat', 'PERINGATAN: BATERAI TIDAK CUKUP', points, batStart, null, nearestFromDest);
                        drawMap(points, '#FF003C');
                    }
                }
                
                mapDiv.style.display = 'block';
                setTimeout(() => map.invalidateSize(), 500);

            } catch (e) {
                alert(e.message);
            } finally {
                stopScanning();
            }
        }

        function findNearestFC(point) {
            let minKm = 99999;
            let nearest = null;
            fcLocations.forEach(fc => {
                const d = getCrowDist(point.lat, point.lon, fc.lat, fc.lng);
                if(d < minKm) { minKm = d; nearest = fc; }
            });
            return nearest ? { ...nearest, dist: minKm } : null;
        }

        async function findBestCharger(start, end, currentBat) {
            let candidates = [];
            for (let fc of fcLocations) {
                const distFromStart = getCrowDist(start.lat, start.lon, fc.lat, fc.lng);
                if (distFromStart <= (currentBat - 5)) {
                    candidates.push({ ...fc, distFromStart });
                }
            }
            if (candidates.length === 0) return null; 

            candidates.sort((a,b) => {
                const distA = getCrowDist(a.lat, a.lng, end.lat, end.lon);
                const distB = getCrowDist(b.lat, b.lng, end.lat, end.lon);
                return distA - distB;
            });

            let bestFC = null;
            let minTotalDist = 999999;
            const checkLimit = Math.min(candidates.length, 3);
            
            for(let i=0; i<checkLimit; i++) {
                const fc = candidates[i];
                const route = await getOSRM([start, {lat: fc.lat, lon: fc.lng}, end]);
                const totalDist = route.distance / 1000;
                if (totalDist < minTotalDist) {
                    minTotalDist = totalDist;
                    bestFC = fc;
                }
            }
            return bestFC;
        }

        async function renderResult(type, title, points, startBat, charger, nearestEnd) {
            const area = document.getElementById('result-area');
            let html = `<div class="route-card ${type}"><div class="card-title"><span>${title}</span><span class="badge ${type}">${type === 'aman' ? 'RECOMMENDED' : 'WARNING'}</span></div><div class="timeline">`;

            let stops = [];
            if (charger) stops = [points[0], {name: charger.name + " (CHARGING)", lat: charger.lat, lon: charger.lng, isCharge: true}, points[points.length-1]];
            else stops = points;

            let currentBat = startBat;

            for (let i = 0; i < stops.length; i++) {
                const pt = stops[i];
                let distInfo = "";
                let batClass = "bat-ok";

                if (i > 0) {
                    const prev = stops[i-1];
                    const leg = await getOSRM([prev, pt]);
                    const dist = leg.distance / 1000;
                    const used = Math.ceil(dist);
                    currentBat -= used;
                    distInfo = `<span style="color:var(--kc-lime); font-size:12px;"><i class="fas fa-arrow-down" style="margin-right:4px;"></i> Jarak Tempuh: ${dist.toFixed(1)} KM (-${used}%)</span>`;
                }

                if (pt.isCharge) {
                    currentBat = 100; 
                    distInfo += ` <span style="color:var(--kc-lime); font-weight:900; background:rgba(212,255,0,0.1); padding:2px 6px; border-radius:4px; font-family:var(--font-tech);">[ ISI PENUH ]</span>`;
                }

                if (currentBat < 20) batClass = "bat-low";

                html += `<div class="t-item"><div class="t-dot"></div><div class="t-info"><div class="t-name">${pt.name}</div><div class="t-meta"><span>${distInfo}</span><span class="t-bat ${batClass}">${currentBat}%</span></div></div></div>`;
            }

            if(nearestEnd) {
                html += `
                <div class="dest-info">
                    <div class="dest-label"><i class="fas fa-plug"></i> CHARGER TERDEKAT DARI TUJUAN</div>
                    <div class="dest-val">${nearestEnd.name}</div>
                    <div style="font-size:12px; color:#8892B0; margin-top:5px; font-weight:800;">Jarak Udara: ${nearestEnd.dist.toFixed(1)} KM</div>
                    <a href="http://googleusercontent.com/maps.google.com/maps?q=${nearestEnd.lat},${nearestEnd.lng}" target="_blank" style="color:var(--kc-lime); font-size:14px; font-weight:900; display:inline-block; margin-top:10px; text-decoration:none; background:rgba(212,255,0,0.1); padding:8px 12px; border-radius:4px;"><i class="fas fa-location-arrow"></i> BUKA MAPS</a>
                </div>`;
            }

            let gmapsLink = `http://googleusercontent.com/maps.google.com/maps?daddr=`;
            stops.forEach((s, idx) => {
                if (idx > 0) gmapsLink += `${s.lat},${s.lon}+to:`;
            });
            gmapsLink = gmapsLink.slice(0, -4); 

            // Tombol Mulai Navigasi disamakan dengan gaya Tactical
            html += `</div><a href="${gmapsLink}" target="_blank" style="text-decoration:none;"><div class="btn-action" style="margin-top:25px;"><i class="fas fa-map"></i> MULAI NAVIGASI</div></a></div>`;
            area.innerHTML = html;
        }

        async function drawMap(points, color) {
            const r = await getOSRM(points);
            const coords = decodePolyline(r.geometry);
            L.polyline(coords, {color: color, weight: 4, opacity: 0.8}).addTo(mapLayers);
            points.forEach((p, i) => {
                const iconColor = i === 0 ? '#39FF14' : (i === points.length-1 ? '#FF003C' : '#D4FF00');
                L.circleMarker([p.lat, p.lon], {radius: 6, color: '#000', weight: 2, fillColor: iconColor, fillOpacity: 1}).addTo(mapLayers).bindPopup(p.name);
            });
            map.fitBounds(L.polyline(coords).getBounds(), {padding:[30,30]});
        }

        async function drawComplexRoute(start, mid, end) {
            drawMap([start, {lat:mid.lat, lon:mid.lng, name:mid.name}, end], '#D4FF00');
        }

        async function getGeo(q) {
            try {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&countrycodes=id&limit=1&addressdetails=1`;
                const r = await fetch(url);
                const d = await r.json();
                if(d[0]) {
                    let cleanName = d[0].display_name.split(',')[0];
                    return { lat: parseFloat(d[0].lat), lon: parseFloat(d[0].lon), name: cleanName };
                }
            } catch(e) { console.log("Error Geo:", e); }
            return null;
        }

        async function getOSRM(pts) {
            const s = pts.map(p => `${p.lon},${p.lat}`).join(';');
            const r = await fetch(`https://router.project-osrm.org/route/v1/driving/${s}?overview=full`);
            const d = await r.json();
            return d.routes[0];
        }

        function getCrowDist(lat1, lon1, lat2, lon2) {
            const R = 6371; const p = Math.PI/180;
            const a = 0.5 - Math.cos((lat2-lat1)*p)/2 + Math.cos(lat1*p)*Math.cos(lat2*p)*(1-Math.cos((lon2-lon1)*p))/2;
            return 2 * R * Math.asin(Math.sqrt(a));
        }

        function decodePolyline(str) {
            let index=0,lat=0,lng=0,coordinates=[],shift=0,result=0,byte=null,latitude_change,longitude_change,factor=1e5;
            while(index<str.length){
                byte=null;shift=0;result=0;
                do{byte=str.charCodeAt(index++)-63;result|=(byte&0x1f)<<shift;shift+=5;}while(byte>=0x20);
                latitude_change=((result&1)?~(result>>1):(result>>1)); shift=result=0;
                do{byte=str.charCodeAt(index++)-63;result|=(byte&0x1f)<<shift;shift+=5;}while(byte>=0x20);
                longitude_change=((result&1)?~(result>>1):(result>>1));
                lat+=latitude_change;lng+=longitude_change;
                coordinates.push([lat/factor,lng/factor]);
            }
            return coordinates;
        }
    </script>
</body>
</html>
