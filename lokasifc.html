<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PETA LOKASI - KARTIKA CHANDRA</title>
    
    <script>
        const CURRENT_VERSION = "8.3_FixGmaps"; 
        if (localStorage.getItem("app_version_map") !== CURRENT_VERSION) {
            if (window.caches) { caches.keys().then((k) => Promise.all(k.map((key) => caches.delete(key)))); }
            localStorage.setItem("app_version_map", CURRENT_VERSION);
            window.location.reload(true);
        }
    </script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=Teko:wght@300;500;700&family=Rajdhani:wght@500;600;700;800;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --bg: #050505; 
            --primary: #D4FF00;       /* Kuning Neon / Lime Baru */
            --primary-dim: rgba(212, 255, 0, 0.15);
            --primary-glow: rgba(212, 255, 0, 0.4);
            --card-bg: #111111;
            --text-main: #ffffff;
            
            --font-head: 'Orbitron', sans-serif;
            --font-body: 'Rajdhani', sans-serif;
            --font-ui: 'Inter', sans-serif;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background: var(--bg); overflow: hidden; font-family: var(--font-body); color: var(--text-main); }

        /* HEADER MODERN KC STYLE */
        .header-fixed {
            position: fixed; top: 0; left: 0; width: 100%; z-index: 1000;
            background: linear-gradient(180deg, rgba(5,5,5,0.95) 0%, rgba(5,5,5,0) 100%);
            padding: 20px 20px 40px 20px; text-align: center; pointer-events: none;
        }
        .main-title { 
            font-family: var(--font-head); font-weight: 800; font-size: 26px; color: #fff; 
            letter-spacing: 2px; text-transform: uppercase; text-shadow: 0 4px 15px var(--primary-glow);
        }
        .sub-title { 
            font-family: var(--font-body); font-size: 11px; color: var(--primary); 
            font-weight: 800; text-transform: uppercase; letter-spacing: 3px;
            margin-top: 5px; display: inline-block; background: rgba(212, 255, 0, 0.1); 
            border: 1px solid rgba(212, 255, 0, 0.4); padding: 4px 12px; border-radius: 20px;
        }

        /* --- TIKTOK BADGE --- */
        .tiktok-badge {
            pointer-events: auto; 
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
            margin-top: 10px; padding: 6px 15px; background: linear-gradient(45deg, #000000, #111111);
            border: 1px solid var(--primary); border-radius: 20px; color: #fff; text-decoration: none;
            font-family: 'Rajdhani', sans-serif; font-size: 12px; font-weight: 800;
            letter-spacing: 1px; transition: 0.3s; box-shadow: 0 0 10px rgba(212, 255, 0, 0.2);
        }
        .tiktok-badge:active { transform: scale(0.95); }
        .tiktok-badge i { color: #fff; font-size: 14px; text-shadow: -1px -1px 0 #00f2fe, 1px 1px 0 #fe0979; }

        /* MAP */
        #map { width: 100%; height: 100vh; z-index: 1; background: #111; }
        .leaflet-control-attribution { display: none !important; }
        .leaflet-routing-container { display: none !important; } 

        /* RESET LEAFLET DIV ICON DEFAULT BACKGROUND AGAR LOGO TIDAK ADA KOTAK PUTIH */
        .clear-icon { background: none !important; border: none !important; }
        
        /* ANIMASI GELOMBANG RADAR DI BELAKANG LOGO */
        @keyframes pulseRadar { 0% {transform: scale(0.6); opacity: 1;} 100% {transform: scale(1.8); opacity: 0;} }

        /* INFO CARD BAWAH */
        .info-card {
            position: fixed; bottom: 80px; 
            left: 0; right: 0; background: var(--card-bg); 
            border-top: 1px solid #333; padding: 25px 20px 30px 20px; 
            z-index: 1500; transform: translateY(150%); 
            transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.8);
        }
        .info-card.active { transform: translateY(0); }
        
        /* Tombol Close Bulet Kiri Atas Peta */
        .btn-map-close { 
            position: absolute; top: -60px; left: 20px; 
            background: rgba(0,0,0,0.8); color: #fff; border: 1px solid #333;
            width: 40px; height: 40px; border-radius: 50%; font-weight: 700; 
            display: flex; align-items: center; justify-content: center; cursor: pointer; 
            z-index: 10001; font-size: 1.2rem;
            opacity: 0; transition: 0.3s; pointer-events: none;
        }
        .info-card.active .btn-map-close { opacity: 1; pointer-events: auto; }
        
        .card-title { font-family: var(--font-ui); font-weight: 900; font-size: 1.6rem; color: #fff; margin: 0 0 8px 0; line-height: 1.1; }
        .card-distance { font-family: var(--font-ui); font-size: 0.9rem; color: #aaa; margin: 0 0 20px 0; border-left: 3px solid var(--primary); padding-left: 10px; }
        
        .btn-nav {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            width: 100%; padding: 16px; border-radius: 12px;
            background: var(--primary); color: #000;
            font-family: var(--font-ui); font-weight: 900; font-size: 1rem; 
            text-transform: uppercase; text-decoration: none; transition: 0.2s; 
        }
        .btn-nav:active { transform: scale(0.97); }

        /* --- DOCK NAV BAWAH --- */
        .dock-container {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 80px;
            background: rgba(5, 5, 5, 0.98); border-top: 2px solid var(--primary);
            display: grid; grid-template-columns: 1fr 1fr 1fr; align-items: center; z-index: 2000;
        }
        .nav-item { text-decoration: none; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666; transition: 0.3s; height: 100%; }
        .nav-item.center-btn { transform: translateY(-30px); }
        .center-icon-box { 
            width: 65px; height: 65px; background: #000; border: 2px solid var(--primary); border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-size: 26px; color: #666; position: relative; z-index: 10; box-shadow: 0 0 25px var(--primary-dim);
        }
        .center-icon-box::after { content:''; position: absolute; inset: -5px; border-radius: 50%; border: 1px dashed rgba(212, 255, 0, 0.3); animation: spin 10s linear infinite; }
        .nav-item.active { color: var(--primary); text-shadow: 0 0 15px var(--primary); }
        .nav-item.active .center-icon-box { color: var(--primary); }
        .nav-icon { font-size: 20px; margin-bottom: 5px; }
        .nav-text { font-family: var(--font-head); font-size: 10px; font-weight: 700; letter-spacing: 2px; }

        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="header-fixed">
        <div class="main-title">PETA LOKASI FC</div>
        <div class="sub-title">MAKA LINTAS KARTIKA CHANDRA</div>
        <br>
        <a href="https://www.tiktok.com/@maka_ojol?_r=1&_t=ZS-93whYgrpbGe" target="_blank" class="tiktok-badge">
            <i class="fab fa-tiktok"></i> @maka_ojol
        </a>
    </div>

    <div id="map"></div>

    <div id="infoCard" class="info-card">
        <button class="btn-map-close" onclick="closeCard()">✕</button>
        
        <h3 class="card-title" id="fcName">Nama Lokasi</h3>
        <p class="card-distance" id="fcDist">Jarak: -- KM</p>
        
        <a href="#" id="btnMaps" target="_blank" class="btn-nav">
            MULAI JALAN (GOOGLE MAPS) ↗
        </a>
    </div>

    <div class="dock-container">
        <div class="nav-item active">
            <i class="fas fa-map-marked-alt nav-icon"></i><span class="nav-text">PETA FC</span>
        </div>
        
        <a href="system.html" class="nav-item center-btn">
            <div class="center-icon-box"><i class="fas fa-charging-station"></i></div>
            <span class="nav-text" style="margin-top:8px;">SYSTEM</span>
        </a>
        
        <a href="plan.html" class="nav-item">
            <i class="fas fa-route nav-icon"></i><span class="nav-text">TRIP PLAN</span>
        </a>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <script>
        // 1. INIT MAP JAWG MATRIX (API DARI INDEX.HTML BAPAK)
        const JAWG_API = "l1PdBwk1arfZcY7wECff2jE2Ts7qpJyMqGGqHK8cjCxcLb6m0FPHm1sExB5NvLyA";
        const map = L.map('map', {zoomControl: false}).setView([-6.200000, 106.816666], 11); 
        
        L.tileLayer(`https://tile.jawg.io/jawg-matrix/{z}/{x}/{y}{r}.png?access-token=${JAWG_API}`, {
            maxZoom: 22
        }).addTo(map);

        // 2. DATA SPREADSHEET
        const SHEET_ID = '1EJOTMMfGpBMFPqR0LzbMbh7tZUcTCZld4x387OO9aJM'; 
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Sheet1`;

        let userLat = null, userLng = null;
        let routingControl = null;
        let userMarker = null;

        // FUNGSI HITUNG JARAK
        function getDist(lat1, lon1, lat2, lon2) {
            const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180;
            const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return (R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))).toFixed(1);
        }

        // 3. GET GPS & BUAT TITIK USER (LOGO KC)
        function initGPS() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    userLat = pos.coords.latitude;
                    userLng = pos.coords.longitude;
                    
                    // ICON USER MENGGUNAKAN LOGO2.PNG DENGAN RADAR NEON
                    const uIcon = L.divIcon({
                        className: 'clear-icon', 
                        html: `
                            <div style="position:relative; width:60px; height:60px; display:flex; align-items:center; justify-content:center;">
                                <div style="position:absolute; width:100%; height:100%; border-radius:50%; background:rgba(212, 255, 0, 0.4); animation:pulseRadar 2s infinite;"></div>
                                <img src="logo2.png" style="width:45px !important; height:45px !important; max-width:45px !important; max-height:45px !important; object-fit:contain; position:relative; z-index:2; filter:drop-shadow(0 4px 8px rgba(0,0,0,0.9));">
                            </div>
                        `,
                        iconSize: [60, 60],
                        iconAnchor: [30, 30]
                    });
                    
                    userMarker = L.marker([userLat, userLng], {icon: uIcon, zIndexOffset: 1000}).addTo(map);
                    map.setView([userLat, userLng], 12); 
                    loadFCData();
                }, (err) => { 
                    console.log("GPS Ditolak/Gagal:", err);
                    loadFCData(); 
                }, { timeout: 10000, enableHighAccuracy: true });
            } else { 
                loadFCData(); 
            }
        }
        
        initGPS();

        function loadFCData() {
            Papa.parse(CSV_URL, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    results.data.forEach(row => {
                        let lat = null, lng = null, name = "STASIUN FC", mapLink = "";

                        const keys = Object.keys(row);
                        for(let k of keys) {
                            let cleanKey = k.toLowerCase().trim();
                            // Ambil Nama
                            if(cleanKey.includes('nama') || cleanKey.includes('station') || cleanKey.includes('lokasi')) {
                                if(row[k] && row[k].trim() !== "") { name = row[k]; }
                            }
                            // Ambil Link Gmaps
                            if(cleanKey.includes('link') || cleanKey.includes('url') || cleanKey.includes('map')) {
                                if(row[k] && row[k].trim() !== "") { mapLink = row[k].trim(); }
                            }
                        }

                        // Ambil Kordinat
                        for(let k of keys) {
                            let val = String(row[k]).replace(',', '.').trim();
                            let num = parseFloat(val);
                            if(isNaN(num)) continue;

                            let cleanKey = k.toLowerCase();
                            if (cleanKey.includes('lat') && num < -5 && num > -11) { lat = num; }
                            if ((cleanKey.includes('long') || cleanKey.includes('lng')) && num > 95 && num < 141) { lng = num; }
                        }

                        // Fallback Kordinat jika format kolom berantakan
                        if (lat === null || lng === null) {
                            Object.values(row).forEach(val => {
                                let v = String(val).replace(',', '.').trim(); let num = parseFloat(v);
                                if (!isNaN(num)) {
                                    if (lat === null && num < 6 && num > -11) lat = num;
                                    else if (lng === null && num > 95 && num < 141) lng = num;
                                }
                            });
                        }

                        // RENDER MARKER FC (Pin Biru Leaflet)
                        if (lat && lng) {
                            const m = L.marker([lat, lng]).addTo(map);
                            m.bindPopup(`<b>${name}</b><br><span style="color:#888; font-size:10px;">Klik untuk melihat rute</span>`);
                            
                            m.on('click', () => {
                                m.openPopup();
                                let distText = "--";
                                if(userLat && userLng) { distText = getDist(userLat, userLng, lat, lng); }
                                showInfo(name, distText, lat, lng, mapLink);
                            });
                        }
                    });
                }
            });
        }

        // --- FUNGSI TAMPILKAN INFO DAN ARAHKAN GOOGLE MAPS ---
        function showInfo(name, dist, lat, lng, mapLink) {
            document.getElementById('fcName').innerText = name;
            document.getElementById('fcDist').innerText = `Jarak: ${dist} KM`;
            
            // PRIORITAS LINK:
            // 1. Jika di Spreadsheet ada Link asli, pakai itu!
            // 2. Jika tidak ada, buat link navigasi otomatis menggunakan API Google Maps (yang dijamin jalan).
            let finalLink = "";
            if (mapLink && mapLink.startsWith("http")) {
                finalLink = mapLink;
            } else if (userLat && userLng) {
                // Rute dari Lokasi User ke Lokasi FC (Mode Navigasi Motor/Mobil)
                finalLink = `https://www.google.com/maps/dir/?api=1&origin=${userLat},${userLng}&destination=${lat},${lng}`;
            } else {
                // Jika user tidak kasih izin GPS, arahkan ke titik lokasinya saja
                finalLink = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
            }
            
            document.getElementById('btnMaps').href = finalLink;
            document.getElementById('infoCard').classList.add('active');

            // HAPUS RUTE LAMA
            if (routingControl) { map.removeControl(routingControl); }

            // TARIK GARIS RUTE BIRU DI PETA APLIKASI
            if (userLat && userLng) {
                routingControl = L.Routing.control({
                    waypoints: [
                        L.latLng(userLat, userLng),
                        L.latLng(lat, lng)
                    ],
                    lineOptions: { styles: [{color: '#00d2ff', opacity: 0.8, weight: 5}] },
                    createMarker: function() { return null; }, 
                    addWaypoints: false, draggableWaypoints: false, fitSelectedRoutes: true, show: false
                }).addTo(map);
            }
        }

        function closeCard() { 
            document.getElementById('infoCard').classList.remove('active'); 
            if (routingControl) { 
                map.removeControl(routingControl); 
                routingControl = null;
            }
            if (userLat && userLng) {
                map.setView([userLat, userLng], 12); 
            }
        }
    </script>
</body>
</html>
